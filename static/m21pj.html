<script>
require.config({
    paths: { music21 : 'http://web.mit.edu/music21/music21j/src/music21', },
});
require(['j2p2j', 'music21'], function (j, music21) {
    buttonClicked = function () {
        j.call('n = note.Note("C#5"); n.ps', function (data) { $('#m21output').text(data) } );
    };
   
    sendStreamToPy = function(s) {
        var sf = s.flat;
        var notes = [];
        for (var i = 0; i < sf.length; i++) {
            var n = sf.get(i);
            notes.push(n.nameWithOctave);
        }
        var notesStr = notes.join(',');
        j.call('streamAnalyze("' + notesStr + '")', function (data) { $('#m21output').text(data) });
    };
    bachMeasure = function () {
        var val = this.value; // bachMeasure I hope
        j.call('m = bachSop.measure(' + val + ')\n' +
                  'sf2 = freezeThaw.StreamFreezer(m);' +
                  'print(sf2.writeStr(fmt="jsonpickle"))', 
                  function (d) { var jpc = new music21.jsonPickle.Converter(); 
                                 var mym = jpc.run(d);
                                 mym.appendNewCanvas('#m21main');
                                 });
        return true;
    };
    startLocal = function () {
        var $main = $("<div id='m21main'><div id='m21output'>Output</div>" + 
            "<button id='clickMe'>click Me</button>" + 
            "</div>");
        $('body').prepend($main);
        $('#clickMe').click(buttonClicked);
        var $bm = $("<input type='text' id='bachMeasure' value='0'/>");
        $bm.off();
        $bm.change(bachMeasure);
        var $closeButton = $("<button id='closeButton'>[ stop ]</button>");
        $closeButton.click(function () { console.log('killing'); j.kernel.kill() });
        $main.append($bm);
        $main.append($closeButton);
        var s = music21.tinyNotation.TinyNotation('3/4 c2. d4 e f g2.');
        s.renderOptions.events['click'] = s.canvasChangerFunction;
        s.changedCallbackFunction = function () { sendStreamToPy(this) };
        s.appendNewCanvas($main);
        
        j.call('from music21 import *');
        j.call('def streamAnalyze(nStr):\n' +
                  '  s = stream.Stream()\n' +
                  '  for ns in nStr.split(","):\n' +
                  '     n = note.Note(ns)\n' +
                  '     s.append(n)\n' +
                  '  return s.analyze("key")\n');
        j.call('bachSop = corpus.parse("bwv66.6").parts[0]');
        
    };
    j.start(startLocal);
});

</script>
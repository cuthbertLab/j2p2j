<html>
<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
    <title>J2P2J Application</title>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/static/components/requirejs/require.js" type="text/javascript" charset="utf-8"></script>
    <script>
      require.config({
          baseUrl: '/static/',
          paths: {
            nbextensions : '/nbextensions',
            underscore : '/static/components/underscore/underscore-min',
            backbone : '/static/components/backbone/backbone-min',
            jquery : '/static/components/jquery/jquery.min',
            j2p2j  : '/static/j2p2j',
          },
          shim: {
            underscore: {
              exports: '_'
            },
            backbone: {
              deps: ["underscore", "jquery"],
              exports: "Backbone"
            },
          }
      });
    </script>
</head>
<body>
<noscript>
    <div id='noscript'>
      This application requires JavaScript.<br>
      Please enable it to proceed.
  </div>
</noscript>
<script>
    IPython = {};
</script>
<script src="/static/base/js/namespace.js" type="text/javascript" charset="utf-8"></script>
<script src="/static/base/js/utils.js" type="text/javascript" charset="utf-8"></script>
<!--  User Code -->
<script>
require.config({
    paths: { music21 : 'http://web.mit.edu/music21/music21j/src/music21', },
});
require(['j2p2j', 'music21'], function (j, music21) {
    buttonClicked = function () {
        j.call('n = note.Note("C#5"); n.ps', function (data) { $('#m21output').text(data) } );
    };
   
    sendStreamToPy = function(s) {
        var sf = s.flat;
        var notes = [];
        for (var i = 0; i < sf.length; i++) {
            var n = sf.get(i);
            notes.push(n.nameWithOctave);
        }
        var notesStr = notes.join(',');
        j.call('streamAnalyze("' + notesStr + '")', function (data) { $('#m21output').text(data) });
    };
    bachMeasure = function () {
        var val = this.value; // bachMeasure I hope
        j.call('m = bachSop.measure(' + val + ')\n' +
                  'sf2 = freezeThaw.StreamFreezer(m);' +
                  'print(sf2.writeStr(fmt="jsonpickle"))', 
                  function (d) { var jpc = new music21.jsonPickle.Converter(); 
                                 var mym = jpc.run(d);
                                 mym.appendNewCanvas('#m21main');
                                 });
        return true;
    };
    startLocal = function () {
        var $main = $("<div id='m21main'><div id='m21output'>Output</div>" + 
            "<button id='clickMe'>click Me</button>" + 
            "</div>");
        $('body').prepend($main);
        $('#clickMe').click(buttonClicked);
        var $bm = $("<input type='text' id='bachMeasure' value='0'/>");
        $bm.off();
        $bm.change(bachMeasure);
        var $closeButton = $("<button id='closeButton'>[ stop ]</button>");
        $closeButton.click(function () { console.log('killing'); j.kernel.kill() });
        $main.append($bm);
        $main.append($closeButton);
        var s = music21.tinyNotation.TinyNotation('3/4 c2. d4 e f g2.');
        s.renderOptions.events['click'] = s.canvasChangerFunction;
        s.changedCallbackFunction = function () { sendStreamToPy(this) };
        s.appendNewCanvas($main);
        
        j.call('from music21 import *');
        j.call('def streamAnalyze(nStr):\n' +
                  '  s = stream.Stream()\n' +
                  '  for ns in nStr.split(","):\n' +
                  '     n = note.Note(ns)\n' +
                  '     s.append(n)\n' +
                  '  return s.analyze("key")\n');
        j.call('bachSop = corpus.parse("bwv66.6").parts[0]');
        
    };
    j.start(startLocal);
});

</script>
<!-- end User Code -->
</body></html>